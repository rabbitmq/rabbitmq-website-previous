<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><meta name="googlebot" content="NOODP" /><meta name="google-site-verification" content="nSYeDgyKM9mw5CWcZuD0xu7iSWXlJijAlg9rcxVOYf4" /><meta name="google-site-verification" content="6UEaC3SWhpGQvqRnSJIEm2swxXpM5Adn4dxZhFsNdw0" /><link rel="stylesheet" href="/v3_5_7/css/rabbit.css" type="text/css" /><style xmlns:html="http://www.w3.org/1999/xhtml" xmlns:doc="http://www.rabbitmq.com/namespaces/ad-hoc/doc">
    body { 
    background: 
    url(/v3_5_7/img/previous-bg.png);
   }
  </style><link rel="icon" type="/image/vnd.microsoft.icon" href="/v3_5_7/favicon.ico" /><link rel="stylesheet" href="/v3_5_7/css/tutorial.css" type="text/css" /><script type="text/javascript" src="/v3_5_7/js/site.js"></script><script type="text/javascript" src="/v3_5_7/js/ga-bootstrap.js"></script><title>RabbitMQ - RabbitMQ tutorial - Topics </title>
    
  </head>
  <body><div id="outerContainer"><div id="rabbit-logo"><a href="/v3_5_7/"><img src="/v3_5_7/img/rabbitmq_logo_strap.png" alt="RabbitMQ" width="253" height="53" /></a></div><div id="pivotal-logo"><a href="http://pivotal.io/"><img src="/v3_5_7/img/logo-pivotal-118x25.png" alt="Pivotal" width="118" height="25" /></a></div><div id="nav-search"><ul class="mainNav"><li><a href="/v3_5_7/features.html">Features</a></li><li><a href="/v3_5_7/download.html">Installation</a></li><li><a href="/v3_5_7/documentation.html">Docs</a></li><li><a href="/v3_5_7/getstarted.html">Tutorials</a></li><li><a href="/v3_5_7/services.html">Support</a></li><li><a href="/v3_5_7/community.html">Community</a></li><li><a href="https://groups.google.com/forum/#!msg/rabbitmq-users/UuvnsOV7yS4/14b8pHcs8I0J">We're Hiring</a></li></ul></div><div class="nav-separator"></div>
<div id="sidebar" class="tutorial-five">
   <ul id="tutorials" xml:base="site/tutorials/tutorials-menu.xml.inc">

        <li id="tutorial-one">
          <h2><span class="tute-num">1</span> <a href="/v3_5_7/tutorials/tutorial-one-python.html">"Hello World!"</a></h2>
          <p>
            The simplest thing that does <em>something</em>
          </p>
          <p><img src="/v3_5_7/img/tutorials/python-one.png" width="180" /></p>
          <p>
          <a href="/v3_5_7/tutorials/tutorial-one-python.html">Python</a>
          |
          <a href="/v3_5_7/tutorials/tutorial-one-java.html">Java</a>
          |
          <a href="/v3_5_7/tutorials/tutorial-one-ruby.html">Ruby</a>
          |
          <a href="/v3_5_7/tutorials/tutorial-one-php.html">PHP</a>
          |
          <a href="/v3_5_7/tutorials/tutorial-one-dotnet.html">C#</a>
          |
          <a href="/v3_5_7/tutorials/tutorial-one-javascript.html">Javascript</a>
          |
          <a href="/v3_5_7/tutorials/tutorial-one-go.html">Go</a>
          </p>
        </li>

        <li id="tutorial-two">
          <h2><span class="tute-num">2</span> <a href="/v3_5_7/tutorials/tutorial-two-python.html">Work queues</a></h2>
          <p>
            Distributing tasks among workers
          </p>
          <p><img src="/v3_5_7/img/tutorials/python-two.png" height="50" width="180" /></p>
          <p>
          <a href="/v3_5_7/tutorials/tutorial-two-python.html">Python</a>
          |
          <a href="/v3_5_7/tutorials/tutorial-two-java.html">Java</a>
          |
          <a href="/v3_5_7/tutorials/tutorial-two-ruby.html">Ruby</a>
          |
          <a href="/v3_5_7/tutorials/tutorial-two-php.html">PHP</a>
          |
          <a href="/v3_5_7/tutorials/tutorial-two-dotnet.html">C#</a>
          |
          <a href="/v3_5_7/tutorials/tutorial-two-javascript.html">Javascript</a>
          |
          <a href="/v3_5_7/tutorials/tutorial-two-go.html">Go</a>
          </p>
        </li>

        <li id="tutorial-three">
          <h2><span class="tute-num">3</span> <a href="/v3_5_7/tutorials/tutorial-three-python.html">Publish/Subscribe</a></h2>
          <p>
            Sending messages to many consumers at once
          </p>
          <p><img src="/v3_5_7/img/tutorials/python-three.png" height="50" width="180" /></p>
          <p>
          <a href="/v3_5_7/tutorials/tutorial-three-python.html">Python</a>
          |
          <a href="/v3_5_7/tutorials/tutorial-three-java.html">Java</a>
          |
          <a href="/v3_5_7/tutorials/tutorial-three-ruby.html">Ruby</a>
          |
          <a href="/v3_5_7/tutorials/tutorial-three-php.html">PHP</a>
          |
          <a href="/v3_5_7/tutorials/tutorial-three-dotnet.html">C#</a>
          |
          <a href="/v3_5_7/tutorials/tutorial-three-javascript.html">Javascript</a>
          |
          <a href="/v3_5_7/tutorials/tutorial-three-go.html">Go</a>
          </p>
        </li>

        <li id="tutorial-four">
          <h2><span class="tute-num">4</span> <a href="/v3_5_7/tutorials/tutorial-four-python.html">Routing</a></h2>
          <p>
            Receiving messages selectively
          </p>
          <p><img src="/v3_5_7/img/tutorials/python-four.png" height="50" width="180" /></p>
          <p>
          <a href="/v3_5_7/tutorials/tutorial-four-python.html">Python</a>
          |
          <a href="/v3_5_7/tutorials/tutorial-four-java.html">Java</a>
          |
          <a href="/v3_5_7/tutorials/tutorial-four-ruby.html">Ruby</a>
          |
          <a href="/v3_5_7/tutorials/tutorial-four-php.html">PHP</a>
          |
          <a href="/v3_5_7/tutorials/tutorial-four-dotnet.html">C#</a>
          |
          <a href="/v3_5_7/tutorials/tutorial-four-javascript.html">Javascript</a>
          |
          <a href="/v3_5_7/tutorials/tutorial-four-go.html">Go</a>
          </p>
        </li>

        <li id="tutorial-five">
          <h2><span class="tute-num">5</span> <a href="/v3_5_7/tutorials/tutorial-five-python.html">Topics</a></h2>
          <p>
            Receiving messages based on a pattern
          </p>
          <p><img src="/v3_5_7/img/tutorials/python-five.png" height="50" width="180" /></p>
          <p>
          <a href="/v3_5_7/tutorials/tutorial-five-python.html">Python</a>
          |
          <a href="/v3_5_7/tutorials/tutorial-five-java.html">Java</a>
          |
          <a href="/v3_5_7/tutorials/tutorial-five-ruby.html">Ruby</a>
          |
          <a href="/v3_5_7/tutorials/tutorial-five-php.html">PHP</a>
          |
          <a href="/v3_5_7/tutorials/tutorial-five-dotnet.html">C#</a>
          |
          <a href="/v3_5_7/tutorials/tutorial-five-javascript.html">Javascript</a>
          |
          <a href="/v3_5_7/tutorials/tutorial-five-go.html">Go</a>
          </p>
        </li>

        <li id="tutorial-six">
          <h2><span class="tute-num">6</span> <a href="/v3_5_7/tutorials/tutorial-six-python.html">RPC</a></h2>
          <p>
            Remote procedure call implementation
          </p>
          <p><img src="/v3_5_7/img/tutorials/python-six.png" height="50" width="180" /></p>
          <p>
          <a href="/v3_5_7/tutorials/tutorial-six-python.html">Python</a>
          |
          <a href="/v3_5_7/tutorials/tutorial-six-java.html">Java</a>
          |
          <a href="/v3_5_7/tutorials/tutorial-six-ruby.html">Ruby</a>
          |
          <a href="/v3_5_7/tutorials/tutorial-six-php.html">PHP</a>
          |
          <a href="/v3_5_7/tutorials/tutorial-six-dotnet.html">C#</a>
          |
          <a href="/v3_5_7/tutorials/tutorial-six-javascript.html">Javascript</a>
          |
          <a href="/v3_5_7/tutorials/tutorial-six-go.html">Go</a>
          </p>
        </li>
      </ul>
</div>

<div id="tutorial">

<h2>Topics</h2>
<h3>(using Go RabbitMQ client)</h3>
<p><div class="aside" xml:base="site/tutorials/tutorials-help.xml.inc">
    <h3>Prerequisites</h3>
    <p>
      This tutorial assumes RabbitMQ is <a href="/v3_5_7/download.html">installed</a> and running
      on <span class="code ">localhost</span> on standard port (<span class="code ">5672</span>). In case you use
      a different host, port or credentials, connections settings would require adjusting.
    </p>

    <h3>Where to get help</h3>
    <p>
        If you're having trouble going through this tutorial you can
        <a href="https://groups.google.com/forum/#!forum/rabbitmq-users">contact us</a> through the mailing list.
    </p>
  </div></p>
<p>In the <a href="tutorial-four-go.html">previous tutorial</a> we improved our
logging system. Instead of using a <span class="code ">fanout</span> exchange only capable of
dummy broadcasting, we used a <span class="code ">direct</span> one, and gained a possibility
of selectively receiving the logs.</p>
<p>Although using the <span class="code ">direct</span> exchange improved our system, it still has
limitations - it can't do routing based on multiple criteria.</p>
<p>In our logging system we might want to subscribe to not only logs
based on severity, but also based on the source which emitted the log.
You might know this concept from the
<a href="http://en.wikipedia.org/wiki/Syslog"><span class="code ">syslog</span></a> unix tool, which
routes logs based on both severity (info/warn/crit...) and facility
(auth/cron/kern...).</p>
<p>That would give us a lot of flexibility - we may want to listen to
just critical errors coming from 'cron' but also all logs from 'kern'.</p>
<p>To implement that in our logging system we need to learn about a more
complex <span class="code ">topic</span> exchange.</p>
<h2>Topic exchange</h2>
<p>Messages sent to a <span class="code ">topic</span> exchange can't have an arbitrary
<span class="code ">routing_key</span> - it must be a list of words, delimited by dots. The
words can be anything, but usually they specify some features
connected to the message. A few valid routing key examples:
"<span class="code ">stock.usd.nyse</span>", "<span class="code ">nyse.vmw</span>", "<span class="code ">quick.orange.rabbit</span>". There can be as
many words in the routing key as you like, up to the limit of 255
bytes.</p>
<p>The binding key must also be in the same form. The logic behind the
<span class="code ">topic</span> exchange is similar to a <span class="code ">direct</span> one - a message sent with a
particular routing key will be delivered to all the queues that are
bound with a matching binding key. However there are two important
special cases for binding keys:</p>
<ul>
<li><span class="code ">*</span> (star) can substitute for exactly one word.</li>
<li><span class="code ">#</span> (hash) can substitute for zero or more words.</li>
</ul>
<p>It's easiest to explain this in an example:</p>
<div class="diagram">
  <img src="/v3_5_7/img/tutorials/python-five.png" height="170" />
  <div class="diagram_source">
    digraph {
      bgcolor=transparent;
      truecolor=true;
      rankdir=LR;
      node [style="filled"];
      //
      P [label="P", fillcolor="#00ffff"];
      subgraph cluster_X1 {
        label="type=topic";
    color=transparent;
        X [label="X", fillcolor="#3333CC"];
      };
      subgraph cluster_Q1 {
        label="Q1";
    color=transparent;
        Q1 [label="{||||}", fillcolor="red", shape="record"];
      };
      subgraph cluster_Q2 {
        label="Q2";
    color=transparent;
        Q2 [label="{||||}", fillcolor="red", shape="record"];
      };
      C1 [label=&lt;C&lt;font point-size="7"&gt;1&lt;/font&gt;&gt;, fillcolor="#33ccff"];
      C2 [label=&lt;C&lt;font point-size="7"&gt;2&lt;/font&gt;&gt;, fillcolor="#33ccff"];
      //
      P -&gt; X;
      X -&gt; Q1 [label="*.orange.*"];
      X -&gt; Q2 [label="*.*.rabbit"];
      X -&gt; Q2 [label="lazy.#"];
      Q1 -&gt; C1;
      Q2 -&gt; C2;
    }
  </div>
</div>

<p>In this example, we're going to send messages which all describe
animals. The messages will be sent with a routing key that consists of
three words (two dots). The first word in the routing key
will describe speed, second a colour and third a species:
"<span class="code ">&lt;speed&gt;.&lt;colour&gt;.&lt;species&gt;</span>".</p>
<p>We created three bindings: Q1 is bound with binding key "<span class="code ">*.orange.*</span>"
and Q2 with "<span class="code ">*.*.rabbit</span>" and "<span class="code ">lazy.#</span>".</p>
<p>These bindings can be summarised as:</p>
<ul>
<li>Q1 is interested in all the orange animals.</li>
<li>Q2 wants to hear everything about rabbits, and everything about lazy
    animals.</li>
</ul>
<p>A message with a routing key set to "<span class="code ">quick.orange.rabbit</span>"
will be delivered to both queues. Message
"<span class="code ">lazy.orange.elephant</span>" also will go to both of them. On the other hand
"<span class="code ">quick.orange.fox</span>" will only go to the first queue, and
"<span class="code ">lazy.brown.fox</span>" only to the second. "<span class="code ">lazy.pink.rabbit</span>" will
be delivered to the second queue only once, even though it matches two bindings.
"<span class="code ">quick.brown.fox</span>" doesn't match any binding so it will be discarded.</p>
<p>What happens if we break our contract and send a message with one or
four words, like "<span class="code ">orange</span>" or "<span class="code ">quick.orange.male.rabbit</span>"? Well,
these messages won't match any bindings and will be lost.</p>
<p>On the other hand "<span class="code ">lazy.orange.male.rabbit</span>", even though it has four
words, will match the last binding and will be delivered to the second
queue.</p>
<blockquote>
<h4>Topic exchange</h4>
<p>Topic exchange is powerful and can behave like other exchanges.</p>
<p>When a queue is bound with "<span class="code ">#</span>" (hash) binding key - it will receive
all the messages, regardless of the routing key - like in <span class="code ">fanout</span> exchange.</p>
<p>When special characters "<span class="code ">*</span>" (star) and "<span class="code ">#</span>" (hash) aren't used in bindings,
the topic exchange will behave just like a <span class="code ">direct</span> one.</p>
</blockquote>
<h2>Putting it all together</h2>
<p>We're going to use a <span class="code ">topic</span> exchange in our logging system. We'll
start off with a working assumption that the routing keys of logs will
have two words: "<span class="code ">&lt;facility&gt;.&lt;severity&gt;</span>".</p>
<p>The code is almost the same as in the
<a href="tutorial-four-go.html">previous tutorial</a>.</p>
<p>The code for <span class="code ">emit_log_topic.go</span>:</p>
<div class="highlight"><pre><span class="k">package</span> <span class="n">main</span>

<span class="k">import</span> <span class="p">(</span>
        <span class="s">"fmt"</span>
        <span class="s">"log"</span>
        <span class="s">"os"</span>
        <span class="s">"strings"</span>

        <span class="s">"github.com/streadway/amqp"</span>
<span class="p">)</span>

<span class="k">func</span> <span class="n">failOnError</span><span class="p">(</span><span class="n">err</span> <span class="n">error</span><span class="p">,</span> <span class="n">msg</span> <span class="nb">string</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="n">err</span> <span class="p">!=</span> <span class="n">nil</span> <span class="p">{</span>
                <span class="n">log</span><span class="p">.</span><span class="n">Fatalf</span><span class="p">(</span><span class="s">"%s: %s"</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="n">err</span><span class="p">)</span>
                <span class="n">panic</span><span class="p">(</span><span class="n">fmt</span><span class="p">.</span><span class="n">Sprintf</span><span class="p">(</span><span class="s">"%s: %s"</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="n">err</span><span class="p">))</span>
        <span class="p">}</span>
<span class="p">}</span>

<span class="k">func</span> <span class="n">main</span><span class="p">()</span> <span class="p">{</span>
        <span class="n">conn</span><span class="p">,</span> <span class="n">err</span> <span class="p">:=</span> <span class="n">amqp</span><span class="p">.</span><span class="n">Dial</span><span class="p">(</span><span class="s">"amqp://guest:guest@localhost:5672/"</span><span class="p">)</span>
        <span class="n">failOnError</span><span class="p">(</span><span class="n">err</span><span class="p">,</span> <span class="s">"Failed to connect to RabbitMQ"</span><span class="p">)</span>
        <span class="k">defer</span> <span class="n">conn</span><span class="p">.</span><span class="n">Close</span><span class="p">()</span>

        <span class="n">ch</span><span class="p">,</span> <span class="n">err</span> <span class="p">:=</span> <span class="n">conn</span><span class="p">.</span><span class="n">Channel</span><span class="p">()</span>
        <span class="n">failOnError</span><span class="p">(</span><span class="n">err</span><span class="p">,</span> <span class="s">"Failed to open a channel"</span><span class="p">)</span>
        <span class="k">defer</span> <span class="n">ch</span><span class="p">.</span><span class="n">Close</span><span class="p">()</span>

        <span class="n">err</span> <span class="p">=</span> <span class="n">ch</span><span class="p">.</span><span class="n">ExchangeDeclare</span><span class="p">(</span>
                <span class="s">"logs_topic"</span><span class="p">,</span> <span class="c1">// name</span>
                <span class="s">"topic"</span><span class="p">,</span>      <span class="c1">// type</span>
                <span class="n">true</span><span class="p">,</span>         <span class="c1">// durable</span>
                <span class="n">false</span><span class="p">,</span>        <span class="c1">// auto-deleted</span>
                <span class="n">false</span><span class="p">,</span>        <span class="c1">// internal</span>
                <span class="n">false</span><span class="p">,</span>        <span class="c1">// no-wait</span>
                <span class="n">nil</span><span class="p">,</span>          <span class="c1">// arguments</span>
        <span class="p">)</span>
        <span class="n">failOnError</span><span class="p">(</span><span class="n">err</span><span class="p">,</span> <span class="s">"Failed to declare an exchange"</span><span class="p">)</span>

        <span class="n">body</span> <span class="p">:=</span> <span class="n">bodyFrom</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">Args</span><span class="p">)</span>
        <span class="n">err</span> <span class="p">=</span> <span class="n">ch</span><span class="p">.</span><span class="n">Publish</span><span class="p">(</span>
                <span class="s">"logs_topic"</span><span class="p">,</span>          <span class="c1">// exchange</span>
                <span class="n">severityFrom</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">Args</span><span class="p">),</span> <span class="c1">// routing key</span>
                <span class="n">false</span><span class="p">,</span> <span class="c1">// mandatory</span>
                <span class="n">false</span><span class="p">,</span> <span class="c1">// immediate</span>
                <span class="n">amqp</span><span class="p">.</span><span class="n">Publishing</span><span class="p">{</span>
                        <span class="n">ContentType</span><span class="p">:</span> <span class="s">"text/plain"</span><span class="p">,</span>
                        <span class="n">Body</span><span class="p">:</span>        <span class="p">[]</span><span class="nb">byte</span><span class="p">(</span><span class="n">body</span><span class="p">),</span>
                <span class="p">})</span>
        <span class="n">failOnError</span><span class="p">(</span><span class="n">err</span><span class="p">,</span> <span class="s">"Failed to publish a message"</span><span class="p">)</span>

        <span class="n">log</span><span class="p">.</span><span class="n">Printf</span><span class="p">(</span><span class="s">" [x] Sent %s"</span><span class="p">,</span> <span class="n">body</span><span class="p">)</span>
<span class="p">}</span>

<span class="k">func</span> <span class="n">bodyFrom</span><span class="p">(</span><span class="n">args</span> <span class="p">[]</span><span class="nb">string</span><span class="p">)</span> <span class="nb">string</span> <span class="p">{</span>
        <span class="k">var</span> <span class="n">s</span> <span class="nb">string</span>
        <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">)</span> <span class="p">&lt;</span> <span class="mi">3</span><span class="p">)</span> <span class="p">||</span> <span class="n">os</span><span class="p">.</span><span class="n">Args</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="p">==</span> <span class="s">""</span> <span class="p">{</span>
                <span class="n">s</span> <span class="p">=</span> <span class="s">"hello"</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                <span class="n">s</span> <span class="p">=</span> <span class="n">strings</span><span class="p">.</span><span class="n">Join</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">2</span><span class="p">:],</span> <span class="s">" "</span><span class="p">)</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="n">s</span>
<span class="p">}</span>

<span class="k">func</span> <span class="n">severityFrom</span><span class="p">(</span><span class="n">args</span> <span class="p">[]</span><span class="nb">string</span><span class="p">)</span> <span class="nb">string</span> <span class="p">{</span>
        <span class="k">var</span> <span class="n">s</span> <span class="nb">string</span>
        <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">)</span> <span class="p">&lt;</span> <span class="mi">2</span><span class="p">)</span> <span class="p">||</span> <span class="n">os</span><span class="p">.</span><span class="n">Args</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="p">==</span> <span class="s">""</span> <span class="p">{</span>
                <span class="n">s</span> <span class="p">=</span> <span class="s">"anonymous.info"</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                <span class="n">s</span> <span class="p">=</span> <span class="n">os</span><span class="p">.</span><span class="n">Args</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="n">s</span>
<span class="p">}</span>
</pre></div>


<p>The code for <span class="code ">receive_logs_topic.go</span>:</p>
<div class="highlight"><pre><span class="k">package</span> <span class="n">main</span>

<span class="k">import</span> <span class="p">(</span>
        <span class="s">"fmt"</span>
        <span class="s">"log"</span>
        <span class="s">"os"</span>

        <span class="s">"github.com/streadway/amqp"</span>
<span class="p">)</span>

<span class="k">func</span> <span class="n">failOnError</span><span class="p">(</span><span class="n">err</span> <span class="n">error</span><span class="p">,</span> <span class="n">msg</span> <span class="nb">string</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="n">err</span> <span class="p">!=</span> <span class="n">nil</span> <span class="p">{</span>
                <span class="n">log</span><span class="p">.</span><span class="n">Fatalf</span><span class="p">(</span><span class="s">"%s: %s"</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="n">err</span><span class="p">)</span>
                <span class="n">panic</span><span class="p">(</span><span class="n">fmt</span><span class="p">.</span><span class="n">Sprintf</span><span class="p">(</span><span class="s">"%s: %s"</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="n">err</span><span class="p">))</span>
        <span class="p">}</span>
<span class="p">}</span>

<span class="k">func</span> <span class="n">main</span><span class="p">()</span> <span class="p">{</span>
        <span class="n">conn</span><span class="p">,</span> <span class="n">err</span> <span class="p">:=</span> <span class="n">amqp</span><span class="p">.</span><span class="n">Dial</span><span class="p">(</span><span class="s">"amqp://guest:guest@localhost:5672/"</span><span class="p">)</span>
        <span class="n">failOnError</span><span class="p">(</span><span class="n">err</span><span class="p">,</span> <span class="s">"Failed to connect to RabbitMQ"</span><span class="p">)</span>
        <span class="k">defer</span> <span class="n">conn</span><span class="p">.</span><span class="n">Close</span><span class="p">()</span>

        <span class="n">ch</span><span class="p">,</span> <span class="n">err</span> <span class="p">:=</span> <span class="n">conn</span><span class="p">.</span><span class="n">Channel</span><span class="p">()</span>
        <span class="n">failOnError</span><span class="p">(</span><span class="n">err</span><span class="p">,</span> <span class="s">"Failed to open a channel"</span><span class="p">)</span>
        <span class="k">defer</span> <span class="n">ch</span><span class="p">.</span><span class="n">Close</span><span class="p">()</span>

        <span class="n">err</span> <span class="p">=</span> <span class="n">ch</span><span class="p">.</span><span class="n">ExchangeDeclare</span><span class="p">(</span>
                <span class="s">"logs_topic"</span><span class="p">,</span> <span class="c1">// name</span>
                <span class="s">"topic"</span><span class="p">,</span>      <span class="c1">// type</span>
                <span class="n">true</span><span class="p">,</span>         <span class="c1">// durable</span>
                <span class="n">false</span><span class="p">,</span>        <span class="c1">// auto-deleted</span>
                <span class="n">false</span><span class="p">,</span>        <span class="c1">// internal</span>
                <span class="n">false</span><span class="p">,</span>        <span class="c1">// no-wait</span>
                <span class="n">nil</span><span class="p">,</span>          <span class="c1">// arguments</span>
        <span class="p">)</span>
        <span class="n">failOnError</span><span class="p">(</span><span class="n">err</span><span class="p">,</span> <span class="s">"Failed to declare an exchange"</span><span class="p">)</span>

        <span class="n">q</span><span class="p">,</span> <span class="n">err</span> <span class="p">:=</span> <span class="n">ch</span><span class="p">.</span><span class="n">QueueDeclare</span><span class="p">(</span>
                <span class="s">""</span><span class="p">,</span>    <span class="c1">// name</span>
                <span class="n">false</span><span class="p">,</span> <span class="c1">// durable</span>
                <span class="n">false</span><span class="p">,</span> <span class="c1">// delete when usused</span>
                <span class="n">true</span><span class="p">,</span>  <span class="c1">// exclusive</span>
                <span class="n">false</span><span class="p">,</span> <span class="c1">// no-wait</span>
                <span class="n">nil</span><span class="p">,</span>   <span class="c1">// arguments</span>
        <span class="p">)</span>
        <span class="n">failOnError</span><span class="p">(</span><span class="n">err</span><span class="p">,</span> <span class="s">"Failed to declare a queue"</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">Args</span><span class="p">)</span> <span class="p">&lt;</span> <span class="mi">2</span> <span class="p">{</span>
                <span class="n">log</span><span class="p">.</span><span class="n">Printf</span><span class="p">(</span><span class="s">"Usage: %s [binding_key]..."</span><span class="p">,</span> <span class="n">os</span><span class="p">.</span><span class="n">Args</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                <span class="n">os</span><span class="p">.</span><span class="n">Exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="p">}</span>
        <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">s</span> <span class="p">:=</span> <span class="k">range</span> <span class="n">os</span><span class="p">.</span><span class="n">Args</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="p">{</span>
                <span class="n">log</span><span class="p">.</span><span class="n">Printf</span><span class="p">(</span><span class="s">"Binding queue %s to exchange %s with routing key %s"</span><span class="p">,</span>
                        <span class="n">q</span><span class="p">.</span><span class="n">Name</span><span class="p">,</span> <span class="s">"logs_topic"</span><span class="p">,</span> <span class="n">s</span><span class="p">)</span>
                <span class="n">err</span> <span class="p">=</span> <span class="n">ch</span><span class="p">.</span><span class="n">QueueBind</span><span class="p">(</span>
                        <span class="n">q</span><span class="p">.</span><span class="n">Name</span><span class="p">,</span>       <span class="c1">// queue name</span>
                        <span class="n">s</span><span class="p">,</span>            <span class="c1">// routing key</span>
                        <span class="s">"logs_topic"</span><span class="p">,</span> <span class="c1">// exchange</span>
                        <span class="n">false</span><span class="p">,</span>
                        <span class="n">nil</span><span class="p">)</span>
                <span class="n">failOnError</span><span class="p">(</span><span class="n">err</span><span class="p">,</span> <span class="s">"Failed to bind a queue"</span><span class="p">)</span>
        <span class="p">}</span>

        <span class="n">msgs</span><span class="p">,</span> <span class="n">err</span> <span class="p">:=</span> <span class="n">ch</span><span class="p">.</span><span class="n">Consume</span><span class="p">(</span>
                <span class="n">q</span><span class="p">.</span><span class="n">Name</span><span class="p">,</span> <span class="c1">// queue</span>
                <span class="s">""</span><span class="p">,</span>     <span class="c1">// consumer</span>
                <span class="n">true</span><span class="p">,</span>   <span class="c1">// auto ack</span>
                <span class="n">false</span><span class="p">,</span>  <span class="c1">// exclusive</span>
                <span class="n">false</span><span class="p">,</span>  <span class="c1">// no local</span>
                <span class="n">false</span><span class="p">,</span>  <span class="c1">// no wait</span>
                <span class="n">nil</span><span class="p">,</span>    <span class="c1">// args</span>
        <span class="p">)</span>
        <span class="n">failOnError</span><span class="p">(</span><span class="n">err</span><span class="p">,</span> <span class="s">"Failed to register a consumer"</span><span class="p">)</span>

        <span class="n">forever</span> <span class="p">:=</span> <span class="nb">make</span><span class="p">(</span><span class="k">chan</span> <span class="n">bool</span><span class="p">)</span>

        <span class="k">go</span> <span class="k">func</span><span class="p">()</span> <span class="p">{</span>
                <span class="k">for</span> <span class="n">d</span> <span class="p">:=</span> <span class="k">range</span> <span class="n">msgs</span> <span class="p">{</span>
                        <span class="n">log</span><span class="p">.</span><span class="n">Printf</span><span class="p">(</span><span class="s">" [x] %s"</span><span class="p">,</span> <span class="n">d</span><span class="p">.</span><span class="n">Body</span><span class="p">)</span>
                <span class="p">}</span>
        <span class="p">}()</span>

        <span class="n">log</span><span class="p">.</span><span class="n">Printf</span><span class="p">(</span><span class="s">" [*] Waiting for logs. To exit press CTRL+C"</span><span class="p">)</span>
        <span class="p">&lt;-</span><span class="n">forever</span>
<span class="p">}</span>
</pre></div>


<p>To receive all the logs:</p>
<div class="highlight"><pre><span class="nv">$ </span>go run receive_logs_topic.go <span class="s2">"#"</span>
</pre></div>


<p>To receive all logs from the facility "<span class="code ">kern</span>":</p>
<div class="highlight"><pre><span class="nv">$ </span>go run receive_logs_topic.go <span class="s2">"kern.*"</span>
</pre></div>


<p>Or if you want to hear only about "<span class="code ">critical</span>" logs:</p>
<div class="highlight"><pre><span class="nv">$ </span>go run receive_logs_topic.go <span class="s2">"*.critical"</span>
</pre></div>


<p>You can create multiple bindings:</p>
<div class="highlight"><pre><span class="nv">$ </span>go run receive_logs_topic.go <span class="s2">"kern.*"</span> <span class="s2">"*.critical"</span>
</pre></div>


<p>And to emit a log with a routing key "<span class="code ">kern.critical</span>" type:</p>
<div class="highlight"><pre><span class="nv">$ </span>go run emit_log_topic.go <span class="s2">"kern.critical"</span> <span class="s2">"A critical kernel error"</span>
</pre></div>


<p>Have fun playing with these programs. Note that the code doesn't make
any assumption about the routing or binding keys, you may want to play
with more than two routing key parameters.</p>
<p>Some teasers:</p>
<ul>
<li>Will "<span class="code ">*</span>" binding catch a message sent with an empty routing key?
   <div class="teaser_answer">
       No.
       go run receive_logs_topic.go "*"
       go run emit_log_topic.go ""
   </div></li>
<li>Will "<span class="code ">#.*</span>" catch a message with a string "<span class="code ">..</span>" as a key? Will
   it catch a message with a single word key?
   <div class="teaser_answer">
       No. (but I don't know why!)
       go run receive_logs_topic.go "#.*"
       go run emit_log_topic.go ".."
       Yes
       go run receive_logs_topic.go "#.*"
       go run emit_log_topic.go "a"
   </div></li>
<li>How different is "<span class="code ">a.*.#</span>" from "<span class="code ">a.#</span>"?
   <div class="teaser_answer">
       'a.*.#' matches anything that has two words or more, and the first
       word is 'a'. But 'a.#' matches anything that has one word or more
       with the first word set to 'a'.
       go run receive_logs_topic.go "a.*.#"
       go run emit_log_topic.go "a.b"
       go run receive_logs_topic.go "a.#"
       go run emit_log_topic.go "a.b"
   </div></li>
</ul>
<p>(Full source code for <a href="https://github.com/rabbitmq/rabbitmq-tutorials/blob/master/go/emit_log_topic.go">emit_log_topic.go</a>
and <a href="https://github.com/rabbitmq/rabbitmq-tutorials/blob/master/go/receive_logs_topic.go">receive_logs_topic.go</a>)</p>
<p>Next, find out how to do a round trip message as a remote procedure call in <a href="tutorial-six-go.html">tutorial 6</a></p></div><div class="clear"></div><div class="pageFooter"><p class="righter"><a href="/v3_5_7/sitemap.html">Sitemap</a> |
        <a href="/v3_5_7/contact.html">Contact</a></p><p id="copyright">
        Copyright © 2015 Pivotal Software, Inc. All rights reserved
        | <a href="http://pivotal.io/privacy-policy">Privacy Policy</a>
        | <a href="https://github.com/rabbitmq/rabbitmq-website/">This Site is Open Source</a>        
        | <a href="https://groups.google.com/forum/#!msg/rabbitmq-users/UuvnsOV7yS4/14b8pHcs8I0J">We're Hiring</a></p></div></div></body>
</html>
